# Hide Apache version information for security
ServerSignature Off
ServerTokens Prod

# This virtual host listens on port 443 and proxies requests to Nginx
<VirtualHost *:443>
    ServerName localhost

    # Enable SSL/TLS for secure connections
    SSLEngine on

    # SSL Certificate files
    # SSLCertificateFile "/vault/certs/nginx.crt"
    # SSLCertificateKeyFile "/vault/certs/nginx.key"
    SSLCertificateFile "/run/secrets/ssl_certificate"
    SSLCertificateKeyFile "/run/secrets/ssl_certificate_key"

    # Disable direct proxy requests (only reverse proxy is allowed)
    ProxyRequests Off

    # Preserve the original Host header when proxying requests
    ProxyPreserveHost On

    # Reverse proxy to Nginx for handling static files, API, and WebSockets
    ProxyPass / http://nginx:8080/
    ProxyPassReverse / http://nginx:8080/

    # WebSockets proxy to Nginx
    ProxyPass /ws/ ws://nginx:8080/ws/
    ProxyPassReverse /ws/ ws://nginx:8080/ws/

    # API proxy to Nginx
    ProxyPass /api/ http://nginx:8080/api/
    ProxyPassReverse /api/ http://nginx:8080/api/

    # Ensure WebSocket connection headers are correctly set
    Header always set Connection upgrade
    Header always set Upgrade websocket
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Disable ModSecurity for WebSockets (avoids interference with real-time traffic)
    <Location /ws/>
        SecRuleEngine Off
        ProxyPass ws://nginx:8080/ws/
        ProxyPassReverse ws://nginx:8080/ws/
    </Location>

    # Modify ModSecurity rules for API requests (avoids false positives)
    <LocationMatch "/api/.*">
        SecRuleRemoveById 920420 949110
    </LocationMatch>

    # Prevent access to hidden files (.git, .env, etc.)
    <Directory "/usr/local/apache2/htdocs">
        <FilesMatch "^\.(?!well-known/).*">
            Require all denied
        </FilesMatch>
    </Directory>

    # Enable gzip compression for text-based content
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
    </IfModule>

    # Enable cache expiration for static assets (Reduces requests for images, CSS, JS)
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 30 days"
        ExpiresByType image/jpeg "access plus 30 days"
        ExpiresByType image/png "access plus 30 days"
        ExpiresByType text/css "access plus 7 days"
        ExpiresByType application/javascript "access plus 7 days"
    </IfModule>

    # Logging settings (send logs to standard output/error for containerized environments)
    LogLevel info
    ErrorLog "/dev/stderr"
    CustomLog "/dev/stdout" combined

</VirtualHost>
